<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手机号获取工具</title>
    <!-- 保持之前的样式不变 -->
    <style>
        /* 保持原有样式不变 */
    </style>
</head>
<body>
    <button id="getBtn" onclick="fetchData()">立即获取手机号</button>
    <div class="loading-text"></div>
    <div id="result"></div>

    <script>
        const API_URL = 'http://api.sqhyw.net:90/api/get_mobile?token=JHgU7pAlOFmgwj2yhrbu22YEQj5ukiCD8mp/z/DU+oiTHcCVjRmy28BOBmryL4avhMpLP3TPLRVnHHC0N6Hc5NhjwUYcVN2nEhWHJyAEIXhD+Ji2TsDEXdZUcqnceCb4N5e3txfaViKcySckknr9ZYCb7Y7LGc5Es2NhzUXheHA=&project_id=774202&special=1';
        let verificationInterval = null;
        let currentRequestCount = 0;

        // 初始化时检查URL参数
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if(token) {
                loadDataByToken(token);
            }
        }

        // 根据token加载数据
        function loadDataByToken(token) {
            const records = JSON.parse(localStorage.getItem('sms_records') || [];
            const record = records.find(r => r.token === token);

            if(record) {
                const btn = document.getElementById('getBtn');
                btn.disabled = true;
                
                const resultElement = document.getElementById('result');
                resultElement.innerHTML = `
                    <div class="info-box number-box">
                        <span class="info-text">${record.mobile}</span>
                        <button class="copy-btn" onclick="copyToClipboard('${record.mobile}')">复制</button>
                    </div>
                    <div class="info-box code-box">
                        <span class="info-text">${record.code || '验证码已过期'}</span>
                        ${record.code ? `<button class="copy-btn" onclick="copyToClipboard('${record.code}')">复制</button>` : ''}
                    </div>
                `;
            }
        }

        // 生成随机token
        function generateToken() {
            return Math.random().toString(36).substr(2, 9).toUpperCase();
        }

        // 保存记录到localStorage
        function saveRecord(mobile, code) {
            const records = JSON.parse(localStorage.getItem('sms_records') || '[]');
            const token = generateToken();
            
            // 保存新记录
            records.push({
                token,
                mobile,
                code,
                timestamp: new Date().getTime()
            });

            // 只保留最近50条记录
            if(records.length > 50) {
                records.shift();
            }

            localStorage.setItem('sms_records', JSON.stringify(records));
            return token;
        }

        async function fetchData() {
            const btn = document.getElementById('getBtn');
            const loadingText = document.querySelector('.loading-text');
            const resultElement = document.getElementById('result');
            
            btn.disabled = true;
            loadingText.textContent = '正在获取号码中...';
            resultElement.innerHTML = '';
            currentRequestCount = 0;

            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`请求失败 (${response.status})`);
                const data = await response.json();
                
                if (data.message === 'ok' && data.mobile) {
                    if (verificationInterval) clearInterval(verificationInterval);

                    const mobile = data.mobile;
                    let code = null;
                    const token = saveRecord(mobile, null); // 先保存手机号

                    // 更新URL
                    history.pushState({}, '', `?token=${token}`);

                    resultElement.innerHTML = `
                        <div class="info-box number-box">
                            <span class="info-text">${mobile}</span>
                            <button class="copy-btn" onclick="copyToClipboard('${mobile}')">复制</button>
                        </div>
                        <div class="info-box code-box">
                            <span class="placeholder-text">正在获取验证码（已请求 0 次）</span>
                            <button class="copy-btn" disabled>复制</button>
                        </div>
                    `;
                    
                    loadingText.textContent = '';
                    
                    const codeBox = resultElement.querySelector('.code-box');
                    const codeText = codeBox.querySelector('span');
                    const codeBtn = codeBox.querySelector('button');

                    verificationInterval = setInterval(async () => {
                        if (currentRequestCount >= 30) {
                            clearInterval(verificationInterval);
                            codeText.textContent = '⚠️ 验证码获取超时';
                            codeText.style.color = '#ff4444';
                            return;
                        }
                        
                        currentRequestCount++;
                        codeText.textContent = `正在获取验证码（已请求 ${currentRequestCount} 次）`;

                        try {
                            const response = await fetch(`http://api.sqhyw.net:90/api/get_message?token=JHgU7pAlOFmgwj2yhrbu22YEQj5ukiCD8mp/z/DU+oiTHcCVjRmy28BOBmryL4avhMpLP3TPLRVnHHC0N6Hc5NhjwUYcVN2nEhWHJyAEIXhD+Ji2TsDEXdZUcqnceCb4N5e3txfaViKcySckknr9ZYCb7Y7LGc5Es2NhzUXheHA=&project_id=774202&phone_num=${mobile}&special=1`);
                            const result = await response.json();
                            
                            if (result.code) {
                                clearInterval(verificationInterval);
                                code = result.code;
                                
                                // 更新记录
                                const records = JSON.parse(localStorage.getItem('sms_records'));
                                const recordIndex = records.findIndex(r => r.token === token);
                                if(recordIndex > -1) {
                                    records[recordIndex].code = code;
                                    localStorage.setItem('sms_records', JSON.stringify(records));
                                }

                                codeText.classList.replace('placeholder-text', 'info-text');
                                codeText.textContent = code;
                                codeBtn.disabled = false;
                                codeBtn.onclick = () => copyToClipboard(code);
                            }
                        } catch (error) {
                            console.error('请求失败:', error);
                        }
                    }, 3000);
                } else {
                    throw new Error(data.message || '无效的响应数据');
                }
            } catch (error) {
                console.error('请求出错:', error);
                loadingText.textContent = `❌ 错误: ${error.message}`;
            } finally {
                btn.disabled = false;
            }
        }

        function copyToClipboard(content) {
            navigator.clipboard.writeText(content)
                .then(() => alert('已成功复制到剪贴板！'))
                .catch(err => console.error('复制失败:', err));
        }
    </script>
</body>
</html>
